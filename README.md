# AstrBot 权限管理插件

## 简介
本插件为 AstrBot 提供**指令级权限控制**功能，可以**完全取代**框架自身权限管理。你可以在独立的 WebUI 中为每个插件的每条指令配置所需的最低权限等级

## 特性
- 🔒 **指令级权限**：为每个插件的每条指令独立设置权限等级（当然你也可以为整个插件设置）
- 🧑‍🤝‍🧑 **用户权限管理**：支持为每个用户（QQ号）或群组单独设置权限等级，管理员自动获得最高权限。
- 🌐 **独立 WebUI**：内置 FastAPI 服务器，提供美观的权限配置页面，支持登录保护。
- 🔍 **实时搜索**：WebUI 支持按插件名或指令名搜索，快速定位配置项。
- 🛡️ **高优先级拦截**：权限检查器以最高优先级运行，确保在所有插件执行前完成校验。
- 📦 **零侵入**：无需修改其他插件代码，通过事件拦截机制实现权限控制。

## 安装

### 通过 AstrBot 插件市场
1. 在 AstrBot WebUI 中打开「插件市场」。
2. 搜索 `astrbot_plugin_permission` 并点击安装。
3. 重启 AstrBot 或重载插件。

### 手动安装

1. 将本插件仓库克隆至 data/plugins/ 目录：
   ```bash
   cd data/plugins
   git clone https://github.com/oujunhaoyueling/astrbot_plugin_permission.git
   ```
2. 重启 AstrBot 或重载插件。

## 配置：

| 配置项 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| `admin_qq` | string | 管理员QQ号，多个用英文逗号分隔（例如 `123456,789012`） | 空 |
| `web_username` | string | WebUI 登录用户名 | `admin` |
| `web_password` | string | WebUI 登录密码 | `admin` |

## 使用方法

### 1. 访问 WebUI 来配置插件所需权限
插件启动后会在 `0.0.0.0:5555` 启动 Web 服务器。打开浏览器访问 `http://你的IP:5555`（记得开防火墙），使用配置的用户名密码登录。

### 2. 配置指令权限
登录后页面将列出所有已加载插件的指令。每个指令旁有一个下拉菜单，可选择权限等级：
- `default` (0)
- `member` (1)
- `moderator` (2)
- `admin` (3)
- `super_admin` (4)

选择后点击左上角蓝色「保存」按钮即可生效。

### 3.在聊天中配置权限（使用“/权限帮助”查看插件命令）（其他唤醒词也可以？）
插件目前支持以下聊天命令（所有命令均需以 `/` 开头）（其它唤醒词也可以？）：

| 命令 | 参数 | 说明 | 可用用户 |
|------|------|------|----------|
| `/授权` | `[群组/私聊] [QQ号/群号] [等级名或数值]` | 设置指定用户或群组的权限等级 | 仅管理员 |
| `/取消授权` | `[群组/私聊] [QQ号/群号]` | 删除指定用户或群组的权限设置，恢复默认等级 | 仅管理员 |
| `/权限列表` | `[可选: 用户QQ/群号]` | 查看所有或指定目标的权限设置 | 仅管理员 |
| `/权限帮助` | 无 | 显示权限管理指令的帮助信息 | 所有人 |
| `/perm_debug` | 无 | 调试：输出当前指令映射和权限配置（用于开发） | 建议仅管理员 |

**注**：
- 管理员由插件配置项 `admin_qq` 定义（多个用逗号分隔）。
- 等级名称与数值对应：`default(0)`、`member(1)`、`moderator(2)`、`admin(3)`、`super_admin(4)`。
- 授权时，若消息来自群聊，最终有效权限等级取用户等级和群组等级的最大值。

### 4. 权限检查
当用户发送以 `/` 开头的指令时（其它唤醒词也可以？），插件会自动执行以下逻辑：
- 获取发送者 QQ 号，若在 `admin_qq` 列表中则直接放行（视为 `super_admin`）。
- 否则从数据库中查询该用户的权限等级（默认为 `default`）。
- 查找指令所属插件及配置的最低等级，若用户等级 < 要求等级，则回复：
  ```
  您没有权限使用 [插件名] 插件的指令 /[指令]，需要等级 [等级名]。
  ```
  并阻止事件传播，后续插件不会执行。

## 5.权限等级说明
| 等级名称 | 数值 | 说明 |
|----------|------|------|
| `default` | 0 | 默认用户等级 |
| `member`  | 1 | 普通成员 |
| `moderator` | 2 | 高级一点的成员 |
| `admin` | 3 | 再高级一点（） |
| `super_admin` | 4 | 超级管理员（请在AstrBot WebUI里的配置项里配置管理员QQ） |

## 6.指令说明
本插件提供一个调试指令（仅在开发时可用）：
- `/perm_debug`：查看当前指令映射和权限配置（仅限管理员）

## 7.依赖
- **Python 3.8+**
- **AstrBot 4.17+**
- **fastapi**、**uvicorn**、**jinja2**

## 8.注意事项
- 管理员QQ在 `admin_qq` 中配置后，这些用户自动获得 `super_admin` 权限，无需在 `permissions` 表中额外设置。
- 插件需要**重载**才能应用配置更改。

## 9.反馈与贡献
如有问题或建议，欢迎提交 [Issue](链接) 或 Pull Request。

---

**如果觉得好用就给个star叭～**
