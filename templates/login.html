<!DOCTYPE html>
<html>
<head>
    <title data-i18n="login.title">æƒé™ç®¡ç† - ç™»å½•</title>
    <meta charset="UTF-8">
    <style>
        /* ========== å…¨å±€å˜é‡ ========== */
        :root {
            --bg-color: #f9f9f9;
            --container-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --input-bg: white;
            --input-border: #ccc;
            --input-focus: #007bff;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --warning-bg: #fff3cd;
            --warning-border: #ffeeba;
            --warning-text: #856404;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --info-text: #6c757d;
            --shadow: rgba(0,0,0,0.1);
            --transition-speed: 0.3s;
        }

        .dark-theme {
            --bg-color: #1a1a1a;
            --container-bg: rgba(30, 30, 30, 0.95);
            --text-color: #e0e0e0;
            --input-bg: #2d2d2d;
            --input-border: #555;
            --input-focus: #4d9fff;
            --button-bg: #4d9fff;
            --button-hover: #1a73e8;
            --warning-bg: #3a3a1a;
            --warning-border: #5a5a2a;
            --warning-text: #ffd970;
            --error-bg: #4a2a2a;
            --error-text: #ff9f9f;
            --info-text: #aaa;
            --shadow: rgba(0,0,0,0.3);
        }

        /* ========== å…¨å±€æ ·å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        box-shadow var(--transition-speed) ease;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            {% if background %}
            background-image: url('/backgrounds/{{ background }}');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            {% endif %}
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ========== ç™»å½•å®¹å™¨ ========== */
        .login-wrapper {
            width: 100%;
            max-width: 400px;
        }

        .login-container {
            background-color: var(--container-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 40px 30px;
            border-radius: 16px;
            box-shadow: 0 8px 30px var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }

        .login-container:hover {
            box-shadow: 0 12px 40px var(--input-focus);
            transform: translateY(-2px);
        }

        /* ========== å¤´éƒ¨ ========== */
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: var(--text-color);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header .subtitle {
            color: var(--info-text);
            font-size: 14px;
        }

        /* ========== å·¥å…·æ  ========== */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tool-btn {
            background: none;
            border: 1px solid var(--input-border);
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .tool-btn:hover {
            background-color: var(--input-focus);
            color: white;
            transform: translateY(-2px);
            border-color: var(--input-focus);
        }

        /* ========== è­¦å‘Šæç¤º ========== */
        .warning {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            color: var(--warning-text);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            animation: slideDown 0.4s ease;
            font-size: 14px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========== è¡¨å• ========== */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: bold;
            font-size: 14px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 15px;
            color: var(--text-color);
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            transform: scale(1.02);
        }

        input[readonly] {
            background-color: var(--input-border);
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* ========== æŒ‰é’® ========== */
        button[type="submit"] {
            width: 100%;
            padding: 14px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        button[type="submit"]:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--button-bg);
        }

        button[type="submit"]:active {
            transform: translateY(0);
        }

        /* ========== é”™è¯¯æç¤º ========== */
        .error {
            color: var(--error-text);
            text-align: center;
            margin-top: 20px;
            padding: 12px;
            background-color: var(--error-bg);
            border-radius: 8px;
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }

        /* ========== åº•éƒ¨ä¿¡æ¯ ========== */
        .info {
            color: var(--info-text);
            text-align: center;
            margin-top: 25px;
            font-size: 13px;
            line-height: 1.6;
        }

        .info a {
            color: var(--input-focus);
            text-decoration: none;
            transition: color 0.2s;
        }

        .info a:hover {
            text-decoration: underline;
        }

        /* ========== å¯†ç å¼ºåº¦æç¤º ========== */
        .password-hint {
            margin-top: 8px;
            font-size: 12px;
            color: var(--info-text);
        }

        .password-weak {
            color: #dc3545;
        }

        .password-strong {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="login-wrapper">
        <!-- å·¥å…·æ ï¼ˆè¯­è¨€åˆ‡æ¢ + ä¸»é¢˜åˆ‡æ¢ï¼‰ -->
        <div class="toolbar">
            <button class="tool-btn" onclick="toggleLanguage()" id="langBtn">ğŸŒ English</button>
            <button class="tool-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™ æš—è‰²</button>
        </div>

        <div class="login-container" style="--login-bg-opacity: 1;">
            <div class="login-header">
                <h1 data-i18n="login.title">æƒé™ç®¡ç†ç™»å½•</h1>
                <div class="subtitle" data-i18n="login.subtitle">è¯·è¾“å…¥ä½ çš„è´¦å·ä¿¡æ¯</div>
            </div>
            
            {% if need_change %}
            <div class="warning" data-i18n="login.need_change">
                (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) é¦–æ¬¡ç™»å½•æˆ–ä½¿ç”¨é»˜è®¤å¯†ç ï¼Œè¯·ä¿®æ”¹å¯†ç 
            </div>
            {% endif %}
            
            <form action="/login" method="post">
                <div class="form-group">
                    <label for="username" data-i18n="login.username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" value="{{ username }}" required {% if need_change %}readonly{% endif %} autofocus>
                </div>
                
                <div class="form-group">
                    <label for="password" data-i18n="login.current_password">{% if need_change %}å½“å‰å¯†ç {% else %}å¯†ç {% endif %}</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                {% if need_change %}
                <div class="form-group">
                    <label for="new_password" data-i18n="login.new_password">æ–°å¯†ç </label>
                    <input type="password" id="new_password" name="new_password" required minlength="6">
                    <div class="password-hint" id="passwordHint" data-i18n="login.password_hint">è‡³å°‘6ä½å­—ç¬¦</div>
                </div>
                
                <div class="form-group">
                    <label for="confirm_password" data-i18n="login.confirm_password">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirm_password" name="confirm_password" required minlength="6">
                </div>
                {% endif %}
                
                <button type="submit" data-i18n="login.submit_btn">{{ "ä¿®æ”¹å¹¶ç™»å½•" if need_change else "ç™»å½•" }}</button>
            </form>
            
            {% if error %}
            <div class="error">{{ error }}</div>
            {% endif %}
            
            <div class="info">
                {% if need_change %}
                <span data-i18n="login.info_first">é¦–æ¬¡ç™»å½•è¯·è®¾ç½®æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰</span>
                {% else %}
                <span data-i18n="login.info_normal">é¦–æ¬¡ç™»å½•å¯†ç åœ¨æ’ä»¶å¯åŠ¨æ—¥å¿—ä¸­æŸ¥çœ‹ï¼Œç™»å½•åå¯ä¿®æ”¹</span>
                {% endif %}
                <br>
                <a href="#" onclick="return false;" style="opacity: 0.6;">(â—•â€¿â—•) v1.0.0</a>
            </div>
        </div>
    </div>

    <script>
        // ========== è¯­è¨€åŒ… ==========
        const i18n = {
            zh: {
                'login.title': 'æƒé™ç®¡ç†ç™»å½•',
                'login.subtitle': 'è¯·è¾“å…¥ä½ çš„è´¦å·ä¿¡æ¯',
                'login.username': 'ç”¨æˆ·å',
                'login.current_password': 'å½“å‰å¯†ç ',
                'login.password': 'å¯†ç ',
                'login.new_password': 'æ–°å¯†ç ',
                'login.confirm_password': 'ç¡®è®¤æ–°å¯†ç ',
                'login.submit_btn': 'ç™»å½•',
                'login.submit_btn_change': 'ä¿®æ”¹å¹¶ç™»å½•',
                'login.need_change': '(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) é¦–æ¬¡ç™»å½•æˆ–ä½¿ç”¨é»˜è®¤å¯†ç ï¼Œè¯·ä¿®æ”¹å¯†ç ',
                'login.info_first': 'é¦–æ¬¡ç™»å½•è¯·è®¾ç½®æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰',
                'login.info_normal': 'é¦–æ¬¡ç™»å½•å¯†ç åœ¨æ’ä»¶å¯åŠ¨æ—¥å¿—ä¸­æŸ¥çœ‹ï¼Œç™»å½•åå¯ä¿®æ”¹',
                'login.password_hint': 'è‡³å°‘6ä½å­—ç¬¦',
                'langBtn': 'ğŸŒ English',
                'themeBtn': 'ğŸŒ™ æš—è‰²'
            },
            en: {
                'login.title': 'Permission Management Login',
                'login.subtitle': 'Please enter your account',
                'login.username': 'Username',
                'login.current_password': 'Current Password',
                'login.password': 'Password',
                'login.new_password': 'New Password',
                'login.confirm_password': 'Confirm Password',
                'login.submit_btn': 'Login',
                'login.submit_btn_change': 'Change & Login',
                'login.need_change': '(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) First login or using default password, please change password',
                'login.info_first': 'First login, set new password (min 6 characters)',
                'login.info_normal': 'Default password can be found in plugin logs, change after login',
                'login.password_hint': 'At least 6 characters',
                'langBtn': 'ğŸŒ ä¸­æ–‡',
                'themeBtn': 'ğŸŒ™ Dark'
            }
        };

        // ========== ä» localStorage è¯»å–è®¾ç½® ==========
        let currentLang = localStorage.getItem('pluginLang') || 'zh';
        let isDark = localStorage.getItem('pluginTheme') === 'dark';
        
        // è¯»å–é€æ˜åº¦å¹¶åº”ç”¨åˆ°å®¹å™¨
        const savedOpacity = localStorage.getItem('pluginBgOpacity');
        if (savedOpacity !== null) {
            const opacity = parseFloat(savedOpacity);
            if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                document.documentElement.style.setProperty('--container-bg', 
                    `rgba(${isDark ? '30,30,30' : '255,255,255'}, ${opacity})`);
            }
        }

        // ========== åº”ç”¨è¯­è¨€ ==========
        function applyLanguage(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'BUTTON') {
                        if (el.type === 'text' || el.type === 'search' || el.type === 'password') {
                            el.placeholder = i18n[lang][key];
                        } else {
                            el.innerText = i18n[lang][key];
                        }
                    } else {
                        el.innerText = i18n[lang][key];
                    }
                }
            });
            
            // å¤„ç†æäº¤æŒ‰é’®çš„ç‰¹æ®Šæƒ…å†µ
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                const isChange = {{ 'true' if need_change else 'false' }};
                submitBtn.innerText = i18n[lang][isChange ? 'login.submit_btn_change' : 'login.submit_btn'];
            }
            
            document.getElementById('langBtn').innerText = i18n[lang]['langBtn'];
            document.getElementById('themeBtn').innerText = i18n[lang]['themeBtn'];
        }

        // ========== åˆ‡æ¢è¯­è¨€ ==========
        window.toggleLanguage = function() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            applyLanguage(currentLang);
            localStorage.setItem('pluginLang', currentLang);
        };

        // ========== åº”ç”¨ä¸»é¢˜ ==========
        function applyTheme(dark) {
            if (dark) {
                document.body.classList.add('dark-theme');
                document.getElementById('themeBtn').innerText = i18n[currentLang]['themeBtn'].replace('ğŸŒ™', 'â˜€ï¸').replace('æš—è‰²', 'äº®è‰²').replace('Dark', 'Light');
            } else {
                document.body.classList.remove('dark-theme');
                document.getElementById('themeBtn').innerText = i18n[currentLang]['themeBtn'];
            }
            
            // é‡æ–°åº”ç”¨é€æ˜åº¦
            const opacity = localStorage.getItem('pluginBgOpacity');
            if (opacity) {
                const val = parseFloat(opacity);
                if (!isNaN(val)) {
                    document.documentElement.style.setProperty('--container-bg', 
                        `rgba(${dark ? '30,30,30' : '255,255,255'}, ${val})`);
                }
            }
        }

        // ========== åˆ‡æ¢ä¸»é¢˜ ==========
        window.toggleTheme = function() {
            isDark = !isDark;
            applyTheme(isDark);
            localStorage.setItem('pluginTheme', isDark ? 'dark' : 'light');
        };

        // ========== åˆå§‹åŒ– ==========
        (function() {
            applyLanguage(currentLang);
            applyTheme(isDark);
            
            // å¯†ç å¼ºåº¦å®æ—¶æ£€æµ‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
            const newPass = document.getElementById('new_password');
            const confirmPass = document.getElementById('confirm_password');
            const hint = document.getElementById('passwordHint');
            
            if (newPass && confirmPass && hint) {
                function checkPasswordStrength() {
                    if (newPass.value.length >= 6) {
                        hint.className = 'password-strong';
                        hint.innerText = i18n[currentLang]['login.password_hint'] + ' âœ“';
                    } else {
                        hint.className = 'password-weak';
                        hint.innerText = i18n[currentLang]['login.password_hint'] + ' âœ—';
                    }
                }
                
                newPass.addEventListener('input', checkPasswordStrength);
            }
        })();

        // ========== è¡¨å•éªŒè¯ï¼ˆä¿®æ”¹å¯†ç æ—¶ï¼‰ ==========
        document.querySelector('form')?.addEventListener('submit', function(e) {
            {% if need_change %}
            const newPass = document.getElementById('new_password')?.value;
            const confirmPass = document.getElementById('confirm_password')?.value;
            
            if (!newPass || !confirmPass) {
                e.preventDefault();
                alert(i18n[currentLang]['login.password_hint']);
                return;
            }
            
            if (newPass !== confirmPass) {
                e.preventDefault();
                alert(currentLang === 'zh' ? 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼' : 'Passwords do not match!');
            } else if (newPass.length < 6) {
                e.preventDefault();
                alert(currentLang === 'zh' ? 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½ï¼' : 'Password must be at least 6 characters!');
            }
            {% endif %}
        });

        // ========== ç›‘å¬é€æ˜åº¦å˜åŒ–ï¼ˆä»å…¶ä»–é¡µé¢ï¼‰ ==========
        window.addEventListener('storage', function(e) {
            if (e.key === 'pluginBgOpacity') {
                const val = parseFloat(e.newValue);
                if (!isNaN(val)) {
                    document.documentElement.style.setProperty('--container-bg', 
                        `rgba(${isDark ? '30,30,30' : '255,255,255'}, ${val})`);
                }
            }
            if (e.key === 'pluginTheme') {
                isDark = e.newValue === 'dark';
                applyTheme(isDark);
            }
        });
    </script>
</body>
</html>