<!DOCTYPE html>
<html>
<head>
    <title data-i18n="login.title">æƒé™ç®¡ç† - ç™»å½•</title>
    <style>
        /* é¡µé¢åŠ è½½æ·¡å…¥åŠ¨ç”» */
        body {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* äº®è‰²/æš—è‰²ä¸»é¢˜å˜é‡ */
        :root {
            --bg-color: #f4f4f4;
            --container-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --label-color: #555;
            --input-border: #ccc;
            --input-focus: #007bff;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --warning-bg: #fff3cd;
            --warning-border: #ffeeba;
            --warning-text: #856404;
            --error-bg: #f8d7da;
            --error-text: #dc3545;
            --info-text: #6c757d;
            --shadow: rgba(0,0,0,0.1);
            --transition-speed: 0.3s;
        }
        .dark-theme {
            --bg-color: #1a1a1a;
            --container-bg: rgba(30, 30, 30, 0.95);
            --text-color: #e0e0e0;
            --label-color: #aaa;
            --input-border: #444;
            --input-focus: #4d9fff;
            --button-bg: #4d9fff;
            --button-hover: #1a73e8;
            --warning-bg: #332e1a;
            --warning-border: #665c33;
            --warning-text: #ffd966;
            --error-bg: #331f1f;
            --error-text: #ff8080;
            --info-text: #aaa;
            --shadow: rgba(0,0,0,0.3);
        }

        * {
            transition: background-color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        box-shadow var(--transition-speed) ease;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
            {% if background %}
            background-image: url('/backgrounds/{{ background }}');
            background-size: cover;
            background-attachment: fixed;
            {% endif %}
        }
        .login-container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px var(--shadow);
            width: 350px;
            transition: box-shadow 0.3s ease;
        }
        .login-container:hover {
            box-shadow: 0 0 15px var(--input-focus);
        }

        /* å·¥å…·æ ï¼šè¯­è¨€/ä¸»é¢˜åˆ‡æ¢ */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tool-btn {
            background: none;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s;
        }
        .tool-btn:hover {
            background-color: var(--input-focus);
            color: white;
            transform: translateY(-2px);
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 24px;
        }
        .warning {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            color: var(--warning-text);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.4s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        label {
            display: block;
            margin: 10px 0 5px;
            color: var(--label-color);
            font-weight: bold;
        }
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 14px;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: all 0.2s ease;
        }
        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 5px var(--input-focus);
            transform: scale(1.02);
        }
        button[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        button[type="submit"]:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--button-bg);
        }
        button[type="submit"]:active {
            transform: translateY(0);
        }
        .error {
            color: var(--error-text);
            text-align: center;
            margin-top: 15px;
            padding: 8px;
            background-color: var(--error-bg);
            border-radius: 4px;
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }
        .info {
            color: var(--info-text);
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <!-- è¯­è¨€/ä¸»é¢˜åˆ‡æ¢å·¥å…·æ  -->
        <div class="toolbar">
            <button class="tool-btn" onclick="toggleLanguage()" id="langBtn">ğŸŒ English</button>
            <button class="tool-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™ æš—è‰²</button>
        </div>

        <h1 data-i18n="login.title">æƒé™ç®¡ç†ç™»å½•</h1>
        
        {% if need_change %}
        <div class="warning" data-i18n="login.warning">
            (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) é¦–æ¬¡ç™»å½•æˆ–ä½¿ç”¨é»˜è®¤å¯†ç ï¼Œè¯·ä¿®æ”¹å¯†ç 
        </div>
        {% endif %}
        
        <form action="/login" method="post">
            <label for="username" data-i18n="login.username">ç”¨æˆ·å</label>
            <input type="text" id="username" name="username" value="{{ username }}" required {% if need_change %}readonly{% endif %} autofocus>
            
            <label for="password" data-i18n="login.password">{{ "å½“å‰å¯†ç " if need_change else "å¯†ç " }}</label>
            <input type="password" id="password" name="password" required>
            
            {% if need_change %}
            <label for="new_password" data-i18n="login.new_password">æ–°å¯†ç </label>
            <input type="password" id="new_password" name="new_password" required minlength="6">
            <label for="confirm_password" data-i18n="login.confirm_password">ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="confirm_password" name="confirm_password" required minlength="6">
            {% endif %}
            
            <button type="submit" data-i18n="login.submit">{{ "ä¿®æ”¹å¹¶ç™»å½•" if need_change else "ç™»å½•" }}</button>
        </form>
        
        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}
        
        <div class="info" data-i18n="login.info">
            {% if need_change %}
            é¦–æ¬¡ç™»å½•è¯·è®¾ç½®æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰
            {% else %}
            é¦–æ¬¡ç™»å½•å¯†ç åœ¨æ’ä»¶å¯åŠ¨æ—¥å¿—ä¸­æŸ¥çœ‹ï¼Œç™»å½•åå¯ä¿®æ”¹
            {% endif %}
        </div>
    </div>

    <script>
        // è¯­è¨€åŒ…
        const i18n = {
            zh: {
                'login.title': 'æƒé™ç®¡ç†ç™»å½•',
                'login.warning': '(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) é¦–æ¬¡ç™»å½•æˆ–ä½¿ç”¨é»˜è®¤å¯†ç ï¼Œè¯·ä¿®æ”¹å¯†ç ',
                'login.username': 'ç”¨æˆ·å',
                'login.password': 'å¯†ç ',
                'login.new_password': 'æ–°å¯†ç ',
                'login.confirm_password': 'ç¡®è®¤æ–°å¯†ç ',
                'login.submit': 'ç™»å½•',
                'login.submit_change': 'ä¿®æ”¹å¹¶ç™»å½•',
                'login.info_default': 'é¦–æ¬¡ç™»å½•å¯†ç åœ¨æ’ä»¶å¯åŠ¨æ—¥å¿—ä¸­æŸ¥çœ‹ï¼Œç™»å½•åå¯ä¿®æ”¹',
                'login.info_change': 'é¦–æ¬¡ç™»å½•è¯·è®¾ç½®æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰',
                'langBtn': 'ğŸŒ English',
                'themeBtn': 'ğŸŒ™ æš—è‰²',
            },
            en: {
                'login.title': 'Permission Management - Login',
                'login.warning': '(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) First login or using default password, please change password',
                'login.username': 'Username',
                'login.password': 'Password',
                'login.new_password': 'New Password',
                'login.confirm_password': 'Confirm Password',
                'login.submit': 'Login',
                'login.submit_change': 'Change & Login',
                'login.info_default': 'Initial password is in the plugin startup log, change after login',
                'login.info_change': 'First login, please set a new password (min 6 characters)',
                'langBtn': 'ğŸŒ ä¸­æ–‡',
                'themeBtn': 'ğŸŒ™ Dark',
            }
        };

        let currentLang = localStorage.getItem('pluginLang') || 'zh';
        let isDark = localStorage.getItem('pluginTheme') === 'dark';

        // åº”ç”¨è¯­è¨€
        function applyLanguage(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'BUTTON') {
                        if (el.type === 'text' || el.type === 'password') {
                            el.placeholder = i18n[lang][key];
                        } else if (el.tagName === 'BUTTON') {
                            el.innerText = i18n[lang][key];
                        }
                    } else {
                        el.innerText = i18n[lang][key];
                    }
                }
            });
            
            // ç‰¹æ®Šå¤„ç†æäº¤æŒ‰é’®æ–‡æœ¬ï¼ˆå› ä¸ºæœ‰ä¸¤ä¸ªå¯èƒ½ï¼‰
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                // ä½¿ç”¨ default è¿‡æ»¤å™¨é¿å…å˜é‡ç¼ºå¤±é”™è¯¯
                const needChange = {{ need_change | default(false) | tojson }};
                submitBtn.innerText = needChange ? i18n[lang]['login.submit_change'] : i18n[lang]['login.submit'];
            }
            
            // æ›´æ–°è¯­è¨€åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
            document.getElementById('langBtn').innerText = i18n[lang]['langBtn'];
            // æ›´æ–°ä¸»é¢˜æŒ‰é’®æ–‡æœ¬
            document.getElementById('themeBtn').innerText = i18n[lang]['themeBtn'];
            
            localStorage.setItem('pluginLang', lang);
        }

        // åˆ‡æ¢è¯­è¨€
        window.toggleLanguage = function() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            applyLanguage(currentLang);
        };

        // åº”ç”¨ä¸»é¢˜
        function applyTheme(dark) {
            if (dark) {
                document.body.classList.add('dark-theme');
                document.getElementById('themeBtn').innerText = i18n[currentLang]['themeBtn'].replace('ğŸŒ™', 'â˜€ï¸').replace('æš—è‰²', 'äº®è‰²').replace('Dark', 'Light');
            } else {
                document.body.classList.remove('dark-theme');
                document.getElementById('themeBtn').innerText = i18n[currentLang]['themeBtn'];
            }
            localStorage.setItem('pluginTheme', dark ? 'dark' : 'light');
        }

        // åˆ‡æ¢ä¸»é¢˜
        window.toggleTheme = function() {
            isDark = !isDark;
            applyTheme(isDark);
        };

        // åˆå§‹åŒ–
        (function() {
            // ä» localStorage è¯»å–é€æ˜åº¦å€¼å¹¶åº”ç”¨åˆ°ç™»å½•å®¹å™¨
            const savedOpacity = localStorage.getItem('pluginBgOpacity');
            if (savedOpacity !== null) {
                const opacity = parseFloat(savedOpacity);
                if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                    document.documentElement.style.setProperty('--login-bg-opacity', opacity);
                }
            }

            // è¯­è¨€
            applyLanguage(currentLang);
            // ä¸»é¢˜
            isDark = localStorage.getItem('pluginTheme') === 'dark';
            applyTheme(isDark);
        })();
    </script>

    {% if need_change %}
    <script>
        document.querySelector('form').addEventListener('submit', function(e) {
            const newPass = document.getElementById('new_password').value;
            const confirmPass = document.getElementById('confirm_password').value;
            
            if (newPass !== confirmPass) {
                e.preventDefault();
                alert(i18n[currentLang]['login.password_mismatch'] || 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
            } else if (newPass.length < 6) {
                e.preventDefault();
                alert(i18n[currentLang]['login.password_too_short'] || 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½ï¼');
            }
        });
    </script>
    {% endif %}
</body>
</html>