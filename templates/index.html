<!DOCTYPE html>
<html>
<head>
    <title data-i18n="index.title">æŒ‡ä»¤æƒé™ç®¡ç†</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        /* å…¨å±€å˜é‡ï¼šäº®è‰²/æš—è‰²ä¸»é¢˜ */
        :root {
            --bg-color: #f9f9f9;
            --container-bg: rgba(255, 255, 255, 0.9);
            --text-color: #333;
            --header-bg: white;
            --plugin-bg: rgba(255, 255, 255, var(--plugin-bg-opacity, 1));
            --border-color: #ddd;
            --input-border: #ccc;
            --input-focus: #007bff;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --tip-bg: #e7f3ff;
            --tip-text: #666;
            --shadow: rgba(0,0,0,0.05);
            --link-color: #007bff;
            --transition-speed: 0.3s;
        }
        .dark-theme {
            --bg-color: #1a1a1a;
            --container-bg: rgba(30, 30, 30, 0.9);
            --text-color: #e0e0e0;
            --header-bg: #2d2d2d;
            --plugin-bg: rgba(40, 40, 40, var(--plugin-bg-opacity, 1));
            --border-color: #444;
            --input-border: #555;
            --input-focus: #4d9fff;
            --button-bg: #4d9fff;
            --button-hover: #1a73e8;
            --tip-bg: #2a3a4a;
            --tip-text: #ccc;
            --shadow: rgba(0,0,0,0.3);
            --link-color: #4d9fff;
        }

        * {
            transition: background-color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        box-shadow var(--transition-speed) ease;
        }

        /* é¡µé¢åŠ è½½æ·¡å…¥åŠ¨ç”» */
        body {
            animation: fadeIn 0.5s ease;
            background-color: var(--bg-color);
            {% if background %}
            background-image: url('/backgrounds/{{ background }}');
            background-size: cover;
            background-attachment: fixed;
            {% endif %}
            font-family: Arial, sans-serif;
            margin: 20px;
            color: var(--text-color);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* æ’ä»¶å—æµ®å…¥åŠ¨ç”» */
        @keyframes slideUpFadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            padding: 10px;
            background-color: var(--header-bg);
            border-radius: 10px;
            box-shadow: 0 2px 4px var(--shadow);
            transition: box-shadow 0.3s ease;
        }
        .header:hover {
            box-shadow: 0 4px 12px var(--input-focus);
        }
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-wrap: wrap;
        }
        .header-left h1 { 
            margin: 0; 
            font-size: 24px;
            color: var(--text-color);
        }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            gap: 10px;
        }
        .tool-btn {
            background: none;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s;
        }
        .tool-btn:hover {
            background-color: var(--input-focus);
            color: white;
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-info span {
            font-weight: bold;
            color: var(--text-color);
        }
        .logout { 
            text-decoration: none; 
            color: var(--text-color); 
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .logout:hover { 
            background-color: var(--input-focus);
            color: white;
            transform: translateY(-2px);
        }

        .search-box { 
            margin: 10px 0; 
            padding: 10px 15px; 
            width: 300px; 
            border: 1px solid var(--input-border); 
            border-radius: 8px; 
            font-size: 14px;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .search-box:focus { 
            outline: none; 
            border-color: var(--input-focus); 
            box-shadow: 0 0 5px var(--input-focus);
            transform: scale(1.02);
        }

        /* æ’ä»¶å¡ç‰‡ */
        .plugin { 
            border: 1px solid var(--border-color); 
            margin-bottom: 20px; 
            padding: 15px; 
            border-radius: 10px; 
            background-color: var(--plugin-bg);
            box-shadow: 0 2px 4px var(--shadow);
            transition: box-shadow 0.2s, background-color 0.3s ease;
            animation: slideUpFadeIn 0.5s ease forwards;
        }
        .plugin:hover {
            box-shadow: 0 4px 8px var(--input-focus);
        }

        /* æ’ä»¶æ ‡é¢˜è¡Œï¼ˆå«æŠ˜å ä¸‰è§’ï¼‰ */
        .plugin-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .plugin-header h2 {
            margin: 0;
            flex: 1;
            font-size: 1.2em;
            color: var(--text-color);
        }
        .collapse-icon {
            font-size: 20px;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        .collapse-icon.expanded {
            transform: rotate(90deg);
        }

        /* æŒ‡ä»¤åˆ—è¡¨å®¹å™¨ï¼Œç”¨äºæŠ˜å  */
        .commands-container {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease;
        }
        .commands-container.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        .command { 
            margin: 12px 0; 
            padding-left: 20px; 
            display: flex; 
            align-items: center; 
        }
        .command label { 
            width: 200px; 
            font-weight: bold; 
            color: var(--text-color);
        }
        .command select { 
            margin-left: 10px; 
            padding: 8px 12px; 
            border: 1px solid var(--input-border); 
            border-radius: 6px; 
            background-color: var(--container-bg); 
            color: var(--text-color);
            cursor: pointer;
            min-width: 120px;
            transition: all 0.2s ease;
        }
        .command select:hover { 
            border-color: var(--input-focus); 
            transform: translateY(-2px);
            box-shadow: 0 2px 4px var(--input-focus);
        }
        .command select:focus { 
            outline: none; 
            border-color: var(--input-focus); 
            box-shadow: 0 0 5px var(--input-focus);
        }

        /* æ’¤é”€æŒ‰é’® */
        .undo-btn {
            margin-left: 10px;
            background: none;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s;
            font-size: 12px;
        }
        .undo-btn:hover:not(:disabled) {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #333;
            transform: translateY(-2px);
        }
        .undo-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .submit { 
            background-color: var(--button-bg); 
            color: white; 
            border: none; 
            padding: 10px 25px; 
            font-size: 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.2s ease;
        }
        .submit:hover { 
            background-color: var(--button-hover); 
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--button-bg);
        }
        .submit:active {
            transform: translateY(0);
        }

        .no-match { 
            color: var(--tip-text); 
            font-style: italic; 
            padding: 30px; 
            text-align: center; 
            background-color: var(--container-bg); 
            border-radius: 8px; 
            border: 1px dashed var(--border-color); 
            animation: fadeIn 0.4s ease;
        }

        .tip {
            color: var(--tip-text);
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background-color: var(--tip-bg);
            border-radius: 6px;
            border-left: 4px solid var(--input-focus);
            animation: fadeIn 0.4s ease;
        }

        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 6px;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .save-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .save-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* æŠ˜å é¢æ¿ï¼ˆèƒŒæ™¯è®¾ç½®ï¼‰ */
        .collapse-panel {
            margin: 20px 0;
            background-color: var(--header-bg);
            border-radius: 10px;
            box-shadow: 0 2px 4px var(--shadow);
            overflow: hidden;
        }
        .collapse-header {
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--header-bg);
        }
        .collapse-header:hover {
            background-color: var(--tip-bg);
        }
        .collapse-header .arrow {
            font-size: 18px;
            transition: transform 0.2s;
        }
        .collapse-header .arrow.expanded {
            transform: rotate(90deg);
        }
        .collapse-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
            padding: 0 20px;
            background-color: var(--container-bg);
            border-top: 1px solid transparent;
        }
        .collapse-content.expanded {
            padding: 20px;
            opacity: 1;
            border-top-color: var(--border-color);
        }

        /* èƒŒæ™¯ä¸Šä¼ åŒºåŸŸå†…éƒ¨æ ·å¼ */
        .background-upload, .opacity-control {
            background: none;
            box-shadow: none;
            padding: 0;
            margin: 0;
        }
        .background-upload {
            margin-bottom: 20px;
        }
        .upload-form {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .upload-form input[type="file"] {
            padding: 5px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--container-bg);
            color: var(--text-color);
        }
        .upload-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .upload-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }
        .upload-btn:active {
            transform: translateY(0);
        }
        .upload-status {
            margin-top: 10px;
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }
        .current-bg {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-color);
        }
        .current-bg img {
            max-width: 100px;
            max-height: 60px;
            border-radius: 4px;
            margin-left: 10px;
            vertical-align: middle;
            transition: transform 0.2s;
        }
        .current-bg img:hover {
            transform: scale(1.1);
        }
        .opacity-control {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .opacity-control label {
            font-weight: bold;
            color: var(--text-color);
        }
        .opacity-control input[type=range] {
            width: 250px;
            cursor: pointer;
            background: var(--input-border);
        }
        .opacity-control span {
            min-width: 40px;
            text-align: center;
            color: var(--text-color);
        }

        /* é¡µè„š */
        .footer {
            text-align: center;
            margin-top: 30px;
            font-size: 14px;
        }
        .footer a {
            color: var(--link-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        .footer a:hover {
            text-decoration: underline;
            color: var(--button-hover);
        }

        /* åº•éƒ¨æŒ‰é’®ç»„ */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        .undo-all-btn {
            background-color: #ffc107;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: #333;
            font-weight: bold;
            transition: all 0.2s;
        }
        .undo-all-btn:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px #ffc107;
        }
        .undo-all-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1 data-i18n="index.title">æŒ‡ä»¤æƒé™ç®¡ç†</h1>
            <button onclick="savePermissions()" class="submit" data-i18n="index.save">ä¿å­˜</button>
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <button class="tool-btn" onclick="toggleLanguage()" id="langBtn">ğŸŒ English</button>
                <button class="tool-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™ æš—è‰²</button>
            </div>
        </div>
        <div class="user-info">
            <span>(â—•â€¿â—•) {{ username }}</span>
            <a href="/logout" class="logout" data-i18n="index.logout">ç™»å‡º</a>
        </div>
    </div>
    
    <div id="saveStatus" class="save-status"></div>
    
    <!-- æŠ˜å é¢æ¿ï¼šèƒŒæ™¯è®¾ç½® -->
    <div class="collapse-panel" id="bgPanel">
        <div class="collapse-header" onclick="togglePanel()">
            <span class="arrow" id="panelArrow">â–¶</span>
            <span class="title" data-i18n="index.bg_settings">èƒŒæ™¯è®¾ç½®</span>
            <span style="color: #888; font-size: 0.9em;" data-i18n="index.click_toggle">(ç‚¹å‡»å±•å¼€/æ”¶èµ·)</span>
        </div>
        <div class="collapse-content" id="panelContent">
            <div class="background-upload">
                <div class="upload-form">
                    <input type="file" id="bgFile" accept=".jpg,.jpeg,.png,.gif,.webp">
                    <button onclick="uploadBackground()" class="upload-btn" data-i18n="index.upload">ä¸Šä¼ èƒŒæ™¯</button>
                </div>
                <div id="uploadStatus" class="upload-status"></div>
                {% if background %}
                <div class="current-bg" data-i18n="index.current_bg" data-i18n-args="{{ background }}">å½“å‰èƒŒæ™¯: {{ background }}</div>
                {% else %}
                <div class="current-bg" data-i18n="index.no_bg">å½“å‰æœªè®¾ç½®èƒŒæ™¯ï¼ˆä½¿ç”¨é»˜è®¤çº¯è‰²ï¼‰</div>
                {% endif %}
            </div>
            <div class="opacity-control">
                <label for="opacitySlider" data-i18n="index.opacity">æŒ‡ä»¤åˆ—è¡¨èƒŒæ™¯é€æ˜åº¦:</label>
                <input type="range" id="opacitySlider" min="0" max="1" step="0.05" value="1">
                <span id="opacityValue">100%</span>
            </div>
        </div>
    </div>
    
    <div style="text-align: right;">
        <input type="text" id="searchInput" class="search-box" placeholder="(Â´ï½¡â€¢ áµ• â€¢ï½¡`) æœç´¢æ’ä»¶ã€æŒ‡ä»¤åâ€¦â€¦" data-i18n="index.search_placeholder">
    </div>
    
    <div class="tip" data-i18n="index.tip">
        (ï½¡â€¢Ì€á´—-)âœ§ æç¤ºï¼šæƒé™ç­‰çº§ä»ä½åˆ°é«˜ä¸º default(0)ã€member(1)ã€moderator(2)ã€admin(3)ã€super_admin(4)
    </div>

    <!-- æ“ä½œæ ï¼šå…¨éƒ¨æ’¤é”€ -->
    <div class="action-bar">
        <button class="undo-all-btn" onclick="undoAllChanges()" id="undoAllBtn" disabled data-i18n="index.undo_all">â†©ï¸ å…¨éƒ¨æ’¤é”€</button>
        <span></span>
    </div>
    
    <div id="pluginsContainer">
        {% for plugin in plugin_data %}
        <div class="plugin" data-plugin-name="{{ plugin.name }}" data-plugin-index="{{ loop.index0 }}" style="animation-delay: {{ loop.index0 * 0.1 }}s;">
            <!-- æ’ä»¶æ ‡é¢˜è¡Œï¼ˆå¸¦æŠ˜å ä¸‰è§’ï¼‰ -->
            <div class="plugin-header" onclick="togglePluginCollapse(this)">
                <span class="collapse-icon" id="plugin-arrow-{{ loop.index0 }}">â–¶</span>
                <h2>{{ plugin.name }}</h2>
            </div>
            <!-- æŒ‡ä»¤åˆ—è¡¨å®¹å™¨ï¼Œç”¨äºæŠ˜å  -->
            <div class="commands-container" id="plugin-commands-{{ loop.index0 }}">
                {% for cmd in plugin.commands %}
                <div class="command" data-plugin="{{ plugin.name }}" data-command="{{ cmd.name }}" data-original-level="{{ cmd.level }}">
                    <label>/{{ cmd.name }}</label>
                    <select class="perm-select" data-plugin="{{ plugin.name }}" data-command="{{ cmd.name }}" onchange="trackChange(this)">
                        {% for level_name, level_value in PERMISSION_LEVELS.items() %}
                        <option value="{{ level_value }}" {% if cmd.level == level_value %}selected{% endif %}>
                            {{ level_name }} ({{ level_value }})
                        </option>
                        {% endfor %}
                    </select>
                    <!-- å•ä¸ªæ’¤é”€æŒ‰é’® -->
                    <button class="undo-btn" onclick="undoCommand(this)" disabled data-i18n="index.undo">â†©ï¸</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div id="noMatchMessage" class="no-match" style="display: none;" data-i18n="index.no_match">
        (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) æ²¡æœ‰åŒ¹é…çš„æ’ä»¶æˆ–æŒ‡ä»¤
    </div>

    <!-- GitHub é“¾æ¥ -->
    <div class="footer">
        <a href="https://github.com/oujunhaoyueling/astrbot_plugin_permission" target="_blank" data-i18n="index.github">âœ¨ å¯¹æ­¤æ’ä»¶æ»¡æ„ï¼Ÿç»™ä¸€ä¸ª starï¼</a>
    </div>

    <script>
        // ---------- è¯­è¨€åŒ… ----------
        const i18n = {
            zh: {
                'index.title': 'æŒ‡ä»¤æƒé™ç®¡ç†',
                'index.save': 'ä¿å­˜',
                'index.logout': 'ç™»å‡º',
                'index.bg_settings': 'èƒŒæ™¯è®¾ç½®',
                'index.click_toggle': '(ç‚¹å‡»å±•å¼€/æ”¶èµ·)',
                'index.upload': 'ä¸Šä¼ èƒŒæ™¯',
                'index.current_bg': 'å½“å‰èƒŒæ™¯: {{0}}',
                'index.no_bg': 'å½“å‰æœªè®¾ç½®èƒŒæ™¯ï¼ˆä½¿ç”¨é»˜è®¤çº¯è‰²ï¼‰',
                'index.opacity': 'æŒ‡ä»¤åˆ—è¡¨èƒŒæ™¯é€æ˜åº¦:',
                'index.search_placeholder': '(Â´ï½¡â€¢ áµ• â€¢ï½¡`) æœç´¢æ’ä»¶ã€æŒ‡ä»¤åâ€¦â€¦',
                'index.tip': '(ï½¡â€¢Ì€á´—-)âœ§ æç¤ºï¼šæƒé™ç­‰çº§ä»ä½åˆ°é«˜ä¸º default(0)ã€member(1)ã€moderator(2)ã€admin(3)ã€super_admin(4)',
                'index.undo_all': 'â†©ï¸ å…¨éƒ¨æ’¤é”€',
                'index.undo': 'â†©ï¸',
                'index.no_match': '(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) æ²¡æœ‰åŒ¹é…çš„æ’ä»¶æˆ–æŒ‡ä»¤',
                'index.github': 'âœ¨ å¯¹æ­¤æ’ä»¶æ»¡æ„ï¼Ÿç»™ä¸€ä¸ª starï¼',
                'langBtn': 'ğŸŒ English',
                'themeBtn': 'ğŸŒ™ æš—è‰²',
                'save_success': '(ï½¡â€¢Ì€á´—-)âœ§ ä¿å­˜æˆåŠŸï¼',
                'save_fail': '(â•¥ï¹â•¥) ä¿å­˜å¤±è´¥ï¼š{{0}}',
                'upload_success': '(ï½¡â€¢Ì€á´—-)âœ§ ä¸Šä¼ æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...',
                'upload_fail': '(â•¥ï¹â•¥) ä¸Šä¼ å¤±è´¥ï¼š{{0}}',
                'confirm_save': 'æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦ä¿å­˜å—ï¼Ÿ',
                'confirm_undo_all': 'ç¡®å®šè¦æ’¤é”€æ‰€æœ‰ä¿®æ”¹å—ï¼Ÿ',
                'uploading': 'ä¸Šä¼ ä¸­...',
            },
            en: {
                'index.title': 'Command Permission Management',
                'index.save': 'Save',
                'index.logout': 'Logout',
                'index.bg_settings': 'Background Settings',
                'index.click_toggle': '(click to expand/collapse)',
                'index.upload': 'Upload Background',
                'index.current_bg': 'Current background: {{0}}',
                'index.no_bg': 'No background set (using default color)',
                'index.opacity': 'Command list background opacity:',
                'index.search_placeholder': '(Â´ï½¡â€¢ áµ• â€¢ï½¡`) Search plugins, commands...',
                'index.tip': '(ï½¡â€¢Ì€á´—-)âœ§ Tip: Permission levels: default(0), member(1), moderator(2), admin(3), super_admin(4)',
                'index.undo_all': 'â†©ï¸ Undo All',
                'index.undo': 'â†©ï¸',
                'index.no_match': '(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) No matching plugins or commands',
                'index.github': 'âœ¨ Satisfied with this plugin? Give a star!',
                'langBtn': 'ğŸŒ ä¸­æ–‡',
                'themeBtn': 'ğŸŒ™ Dark',
                'save_success': '(ï½¡â€¢Ì€á´—-)âœ§ Saved successfully!',
                'save_fail': '(â•¥ï¹â•¥) Save failed: {{0}}',
                'upload_success': '(ï½¡â€¢Ì€á´—-)âœ§ Upload successful! Refreshing...',
                'upload_fail': '(â•¥ï¹â•¥) Upload failed: {{0}}',
                'confirm_save': 'You have unsaved changes. Confirm save?',
                'confirm_undo_all': 'Undo all changes?',
                'uploading': 'Uploading...',
            }
        };

        let currentLang = localStorage.getItem('pluginLang') || 'zh';
        let isDark = localStorage.getItem('pluginTheme') === 'dark';
        let changes = new Map(); // è®°å½•ä¿®æ”¹ï¼škey = "plugin|command", value = newLevel
        let originalValues = new Map(); // è®°å½•åŸå§‹å€¼

        // åˆå§‹åŒ–åŸå§‹å€¼
        document.querySelectorAll('.perm-select').forEach(select => {
            const plugin = select.dataset.plugin;
            const command = select.dataset.command;
            const original = select.value;
            originalValues.set(`${plugin}|${command}`, original);
        });

        // è·Ÿè¸ªä¿®æ”¹
        window.trackChange = function(select) {
            const plugin = select.dataset.plugin;
            const command = select.dataset.command;
            const newVal = select.value;
            const key = `${plugin}|${command}`;
            const original = originalValues.get(key);
            if (newVal === original) {
                changes.delete(key);
            } else {
                changes.set(key, newVal);
            }
            updateUndoButtons();
        };

        // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
        function updateUndoButtons() {
            // å•ä¸ªæ’¤é”€
            document.querySelectorAll('.perm-select').forEach(select => {
                const plugin = select.dataset.plugin;
                const command = select.dataset.command;
                const key = `${plugin}|${command}`;
                const undoBtn = select.closest('.command').querySelector('.undo-btn');
                if (changes.has(key)) {
                    undoBtn.disabled = false;
                } else {
                    undoBtn.disabled = true;
                }
            });
            // å…¨éƒ¨æ’¤é”€
            document.getElementById('undoAllBtn').disabled = changes.size === 0;
        }

        // å•ä¸ªæ’¤é”€
        window.undoCommand = function(btn) {
            const commandDiv = btn.closest('.command');
            const select = commandDiv.querySelector('.perm-select');
            const plugin = select.dataset.plugin;
            const command = select.dataset.command;
            const key = `${plugin}|${command}`;
            const original = originalValues.get(key);
            select.value = original;
            changes.delete(key);
            updateUndoButtons();
            // è§¦å‘ change äº‹ä»¶ä»¥ä¾¿åç»­ä¿å­˜
            select.dispatchEvent(new Event('change', { bubbles: true }));
        };

        // å…¨éƒ¨æ’¤é”€
        window.undoAllChanges = function() {
            if (!confirm(i18n[currentLang]['confirm_undo_all'])) return;
            document.querySelectorAll('.perm-select').forEach(select => {
                const plugin = select.dataset.plugin;
                const command = select.dataset.command;
                const key = `${plugin}|${command}`;
                const original = originalValues.get(key);
                select.value = original;
            });
            changes.clear();
            updateUndoButtons();
        };

        // ä¿å­˜å‰äºŒæ¬¡ç¡®è®¤
        window.savePermissions = async function() {
            if (changes.size > 0 && !confirm(i18n[currentLang]['confirm_save'])) {
                return;
            }
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const selects = document.querySelectorAll('.perm-select');
            const permissions = [];
            
            selects.forEach(select => {
                const plugin = select.getAttribute('data-plugin');
                const command = select.getAttribute('data-command');
                const level = parseInt(select.value);
                
                permissions.push({
                    plugin: plugin,
                    command: command,
                    level: level
                });
            });
            
            try {
                const response = await fetch('/save_permissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ permissions: permissions })
                });
                
                const result = await response.json();
                
                if (response.ok && result.status === 'success') {
                    showSaveStatus(i18n[currentLang]['save_success'], true);
                    // é‡ç½®åŸå§‹å€¼å’Œä¿®æ”¹è®°å½•
                    originalValues.clear();
                    document.querySelectorAll('.perm-select').forEach(select => {
                        const plugin = select.dataset.plugin;
                        const command = select.dataset.command;
                        originalValues.set(`${plugin}|${command}`, select.value);
                    });
                    changes.clear();
                    updateUndoButtons();
                } else {
                    showSaveStatus(i18n[currentLang]['save_fail'].replace('{{0}}', result.message || ''), false);
                }
            } catch (error) {
                showSaveStatus(i18n[currentLang]['save_fail'].replace('{{0}}', 'ç½‘ç»œé”™è¯¯'), false);
                console.error('Save error:', error);
            }
        };

        // æ¨¡ç³Šæœç´¢
        window.filterPlugins = function() {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            const plugins = document.querySelectorAll('.plugin');
            let anyVisible = false;

            plugins.forEach(plugin => {
                const pluginName = plugin.getAttribute('data-plugin-name').toLowerCase();
                const commands = plugin.querySelectorAll('.command');
                
                let pluginMatch = searchText === '' || pluginName.includes(searchText);
                
                if (!pluginMatch) {
                    for (let cmd of commands) {
                        const cmdName = cmd.getAttribute('data-command').toLowerCase();
                        if (cmdName.includes(searchText)) {
                            pluginMatch = true;
                            break;
                        }
                    }
                }

                if (pluginMatch) {
                    plugin.style.display = 'block';
                    plugin.style.animation = 'slideUpFadeIn 0.3s ease';
                    anyVisible = true;
                } else {
                    plugin.style.display = 'none';
                }
            });

            document.getElementById('noMatchMessage').style.display = anyVisible ? 'none' : 'block';
        };

        // æ’ä»¶å¡ç‰‡æŠ˜å 
        window.togglePluginCollapse = function(header) {
            const pluginDiv = header.closest('.plugin');
            const commandsContainer = pluginDiv.querySelector('.commands-container');
            const icon = header.querySelector('.collapse-icon');
            const isCollapsed = commandsContainer.classList.contains('collapsed');
            if (isCollapsed) {
                commandsContainer.classList.remove('collapsed');
                commandsContainer.style.maxHeight = commandsContainer.scrollHeight + 'px';
                icon.classList.add('expanded');
            } else {
                commandsContainer.classList.add('collapsed');
                commandsContainer.style.maxHeight = '0';
                icon.classList.remove('expanded');
            }
            // ä¿å­˜çŠ¶æ€åˆ° localStorage
            const pluginName = pluginDiv.dataset.pluginName;
            localStorage.setItem(`plugin_collapse_${pluginName}`, isCollapsed ? 'expanded' : 'collapsed');
        };

        // åˆå§‹åŒ–æ’ä»¶æŠ˜å çŠ¶æ€
        function initPluginCollapse() {
            document.querySelectorAll('.plugin').forEach(plugin => {
                const pluginName = plugin.dataset.pluginName;
                const saved = localStorage.getItem(`plugin_collapse_${pluginName}`);
                const commandsContainer = plugin.querySelector('.commands-container');
                const icon = plugin.querySelector('.collapse-icon');
                if (saved === 'collapsed') {
                    commandsContainer.classList.add('collapsed');
                    commandsContainer.style.maxHeight = '0';
                    icon.classList.remove('expanded');
                } else {
                    commandsContainer.classList.remove('collapsed');
                    commandsContainer.style.maxHeight = commandsContainer.scrollHeight + 'px';
                    icon.classList.add('expanded');
                }
            });
        }

        // è¯­è¨€/ä¸»é¢˜åˆ‡æ¢å‡½æ•°
        function applyLanguage(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'BUTTON') {
                        if (el.type === 'text' || el.type === 'search') {
                            el.placeholder = i18n[lang][key];
                        } else {
                            el.value = i18n[lang][key];
                        }
                    } else {
                        el.innerText = i18n[lang][key];
                    }
                }
            });
            document.getElementById('langBtn').innerText = i18n[lang]['langBtn'];
            document.getElementById('themeBtn').innerText = i18n[lang]['themeBtn'];
            localStorage.setItem('pluginLang', lang);
        }

        window.toggleLanguage = function() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            applyLanguage(currentLang);
        };

        function applyTheme(dark) {
            if (dark) {
                document.body.classList.add('dark-theme');
                document.getElementById('themeBtn').innerText = i18n[currentLang]['themeBtn'].replace('ğŸŒ™', 'â˜€ï¸').replace('æš—è‰²', 'äº®è‰²').replace('Dark', 'Light');
            } else {
                document.body.classList.remove('dark-theme');
                document.getElementById('themeBtn').innerText = i18n[currentLang]['themeBtn'];
            }
            localStorage.setItem('pluginTheme', dark ? 'dark' : 'light');
        }

        window.toggleTheme = function() {
            isDark = !isDark;
            applyTheme(isDark);
        };

        // èƒŒæ™¯ä¸Šä¼ 
        window.uploadBackground = async function() {
            const fileInput = document.getElementById('bgFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
                return;
            }

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const formData = new FormData();
            formData.append('file', file);

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = i18n[currentLang]['uploading'] || 'ä¸Šä¼ ä¸­...';
            statusDiv.style.color = '#007bff';

            try {
                const response = await fetch('/upload_background', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-Token': csrfToken
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    statusDiv.innerHTML = i18n[currentLang]['upload_success'];
                    statusDiv.style.color = '#28a745';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    statusDiv.innerHTML = i18n[currentLang]['upload_fail'].replace('{{0}}', result.message || '');
                    statusDiv.style.color = '#dc3545';
                }
            } catch (error) {
                statusDiv.innerHTML = i18n[currentLang]['upload_fail'].replace('{{0}}', 'ç½‘ç»œé”™è¯¯');
                statusDiv.style.color = '#dc3545';
                console.error('Upload error:', error);
            }
        };

        // ---------- èƒŒæ™¯è®¾ç½®é¢æ¿æŠ˜å å‡½æ•° ----------
        (function() {
            const panelContent = document.getElementById('panelContent');
            const panelArrow = document.getElementById('panelArrow');
            
            // ä» localStorage è¯»å–æŠ˜å çŠ¶æ€ï¼Œé»˜è®¤æ”¶èµ·ï¼ˆfalseï¼‰
            const isExpanded = localStorage.getItem('bgPanelExpanded') === 'true';
            
            function setInitialState(expanded) {
                if (expanded) {
                    panelContent.classList.add('expanded');
                    panelContent.style.maxHeight = panelContent.scrollHeight + 'px';
                    panelArrow.classList.add('expanded');
                    panelArrow.textContent = 'â–¼';
                } else {
                    panelContent.classList.remove('expanded');
                    panelContent.style.maxHeight = '0';
                    panelArrow.classList.remove('expanded');
                    panelArrow.textContent = 'â–¶';
                }
            }
            
            function togglePanel(expanded) {
                if (expanded) {
                    panelContent.classList.add('expanded');
                    panelContent.style.maxHeight = panelContent.scrollHeight + 'px';
                    panelArrow.classList.add('expanded');
                    panelArrow.textContent = 'â–¼';
                } else {
                    panelContent.classList.remove('expanded');
                    panelContent.style.maxHeight = '0';
                    panelArrow.classList.remove('expanded');
                    panelArrow.textContent = 'â–¶';
                }
            }
            
            setInitialState(isExpanded);
            
            window.togglePanel = function() {
                const currentlyExpanded = panelContent.classList.contains('expanded');
                const newState = !currentlyExpanded;
                togglePanel(newState);
                localStorage.setItem('bgPanelExpanded', newState);
            };
            
            window.addEventListener('resize', function() {
                if (panelContent.classList.contains('expanded')) {
                    panelContent.style.maxHeight = panelContent.scrollHeight + 'px';
                }
            });
        })();

        // åˆå§‹åŒ–
        (function() {
            applyLanguage(currentLang);
            isDark = localStorage.getItem('pluginTheme') === 'dark';
            applyTheme(isDark);
            initPluginCollapse();

            // é€æ˜åº¦æ»‘å—
            const slider = document.getElementById('opacitySlider');
            const valueSpan = document.getElementById('opacityValue');
            const root = document.documentElement;
            const savedOpacity = localStorage.getItem('pluginBgOpacity');
            if (savedOpacity !== null) {
                const opacity = parseFloat(savedOpacity);
                if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {
                    slider.value = opacity;
                    root.style.setProperty('--plugin-bg-opacity', opacity);
                    valueSpan.textContent = Math.round(opacity * 100) + '%';
                }
            }
            slider.addEventListener('input', function() {
                const val = parseFloat(slider.value);
                root.style.setProperty('--plugin-bg-opacity', val);
                valueSpan.textContent = Math.round(val * 100) + '%';
                localStorage.setItem('pluginBgOpacity', val);
            });

            // æœç´¢æ¡†äº‹ä»¶
            document.getElementById('searchInput').addEventListener('input', filterPlugins);
            filterPlugins();
        })();

        function showSaveStatus(message, isSuccess) {
            const status = document.getElementById('saveStatus');
            status.textContent = message;
            status.className = 'save-status ' + (isSuccess ? 'success' : 'error');
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>